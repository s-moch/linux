#include <linux/delay.h>
#include "saa716x_reg.h"
#include "saa716x_priv.h"

#define CGU_CLKS	15
#define PLL_FREQ	2500

int saa716x_cgu_init(struct saa716x_dev *saa716x)
{
	int M, N;
	u8 i;
	u32 boot_div[15], freq[15];
	u32 CGU_FDC[15] = {
		CGU_FDC_0,
		CGU_FDC_1,
		CGU_FDC_2,
		CGU_FDC_3,
		CGU_FDC_4,
		CGU_FDC_5,
		CGU_FDC_6,
		CGU_FDC_7,
		CGU_FDC_8,
		CGU_FDC_9,
		CGU_FDC_10,
		CGU_FDC_11,
		CGU_FDC_12,
		CGU_FDC_13,
	};

	SAA716x_WR(CGU, CGU_PCR_0_6, CGU_PCR_RUN); /* GREG */
	SAA716x_WR(CGU, CGU_PCR_0_3, CGU_PCR_RUN); /* MMU */
	SAA716x_WR(CGU, CGU_PCR_0_4, CGU_PCR_RUN); /* DTL2MTL */
	SAA716x_WR(CGU, CGU_PCR_0_5, CGU_PCR_RUN); /* MSI */
	SAA716x_WR(CGU, CGU_PCR_3_2, CGU_PCR_RUN); /* I2C */
	SAA716x_WR(CGU, CGU_PCR_4_1, CGU_PCR_RUN); /* PHI */
	SAA716x_WR(CGU, CGU_PCR_0_7, CGU_PCR_RUN); /* GPIO */
	SAA716x_WR(CGU, CGU_PCR_2_1, CGU_PCR_RUN); /* SPI */
	SAA716x_WR(CGU, CGU_PCR_1_1, CGU_PCR_RUN); /* DCS */
	SAA716x_WR(CGU, CGU_PCR_3_1, CGU_PCR_RUN); /* BOOT */

	dprintk(SAA716x_DEBUG, 1, "Initial Clocks setup");

	for (i = 0; i < CGU_CLKS; i++) {
		boot_div[i] = SAA716x_RD(CGU, CGU_FDC[i]);

		N  =  (boot_div[i] >> 11) & 0xff;
		N *= -1;
		M  = ((boot_div[i] >> 3) & 0xff) + N;

		if (M)
			freq[i] = (N * PLL_FREQ) / M;
		else
			freq[i] = 0;

		dprintk(SAA716x_DEBUG, 1, "Clock %d, M=%d, Frequency=%d",
			i, M, freq[i]);
	}

	/* VI 0 */
	SAA716x_WR(CGU, CGU_PCR_5, CGU_PCR_RUN); /* Run */
	SAA716x_WR(CGU, CGU_SCR_5, CGU_SCR_ENF1); /* Switch */
	SAA716x_WR(CGU, CGU_FS1_5, 0x00000000); /* PLL Clk */
	SAA716x_WR(CGU, CGU_ESR_5, CGU_ESR_FD_EN); /* Frac div */

	/* VI 1 */
	SAA716x_WR(CGU, CGU_PCR_6, CGU_PCR_RUN);
	SAA716x_WR(CGU, CGU_SCR_6, CGU_SCR_ENF1);
	SAA716x_WR(CGU, CGU_FS1_6, 0x00000000);
	SAA716x_WR(CGU, CGU_ESR_6, CGU_ESR_FD_EN);

	/* FGPI 0 */
	SAA716x_WR(CGU, CGU_PCR_7, CGU_PCR_RUN);
	SAA716x_WR(CGU, CGU_SCR_7, CGU_SCR_ENF1);
	SAA716x_WR(CGU, CGU_FS1_7, 0x00000000);
	SAA716x_WR(CGU, CGU_ESR_7, CGU_ESR_FD_EN);

	/* FGPI 1 */
	SAA716x_WR(CGU, CGU_PCR_8, CGU_PCR_RUN);
	SAA716x_WR(CGU, CGU_SCR_8, CGU_SCR_ENF1);
	SAA716x_WR(CGU, CGU_FS1_8, 0x00000000);
	SAA716x_WR(CGU, CGU_ESR_8, CGU_ESR_FD_EN);

	/* FGPI 2 */
	SAA716x_WR(CGU, CGU_PCR_9, CGU_PCR_RUN);
	SAA716x_WR(CGU, CGU_SCR_9, CGU_SCR_ENF1);
	SAA716x_WR(CGU, CGU_FS1_9, 0x00000000);
	SAA716x_WR(CGU, CGU_ESR_9, CGU_ESR_FD_EN);

	/* FGPI 3 */
	SAA716x_WR(CGU, CGU_PCR_10, CGU_PCR_RUN);
	SAA716x_WR(CGU, CGU_SCR_10, CGU_SCR_ENF1);
	SAA716x_WR(CGU, CGU_FS1_10, 0x00000000);
	SAA716x_WR(CGU, CGU_ESR_10, CGU_ESR_FD_EN);

	/* AI 0 */
	SAA716x_WR(CGU, CGU_PCR_11, CGU_PCR_RUN);
	SAA716x_WR(CGU, CGU_SCR_11, CGU_SCR_ENF1);
	SAA716x_WR(CGU, CGU_FS1_11, 0x00000000);
	SAA716x_WR(CGU, CGU_ESR_11, CGU_ESR_FD_EN);

	/* AI 1 */
	SAA716x_WR(CGU, CGU_PCR_12, CGU_PCR_RUN);
	SAA716x_WR(CGU, CGU_SCR_12, CGU_SCR_ENF1);
	SAA716x_WR(CGU, CGU_FS1_12, 0x00000000);
	SAA716x_WR(CGU, CGU_ESR_12, CGU_ESR_FD_EN);

	msleep(50); /* wait for PLL */

	return 0;
}
EXPORT_SYMBOL_GPL(saa716x_cgu_init);
